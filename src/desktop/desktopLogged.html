<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="../../css/general.css" />
  <link rel="stylesheet" href="../../css/header.css" />
  <link rel="stylesheet" href="../../css/desktop.css" />
  <link rel="stylesheet" href="../../css/modal.css" />
  <link rel="stylesheet" href="../../css/desktopLogged.css" />
  <title>TFT Assistant - Desktop</title>
</head>

<body class="desktop">
  <!-- -------------------------------- Header ------------------------------- -->

  <header id="header" class="app-header">
    <img src="../../icons/appIcon.ico" width="20px" />
    <h1>TFT Assistant</h1>
    <div class="window-controls-group">
      <button id="minimizeButton" class="window-control window-control-minimize" />
      <button id="maximizeButton" class="window-control window-control-maximize" />
      <button id="closeButton" class="window-control window-control-close" />
    </div>
  </header>

  <!-- --------------------------------- Main -------------------------------- -->
  <main>
    <div class="headerLogged">
      <span class="welcome-text" id="welcomeText">Welcome!</span>
      <div class="logout" id="logoutBtn" style="cursor: pointer;">
        <img src="../../icons/logout.svg" alt="leaveIcon" width="50px" />
      </div>
    </div>

    <div class="logo-container">
      <div class="logo">
        <img src="../../img/LogoTFT.png" width="200px" />
      </div>
    </div>

    <div class="cards-container">
      <div class="card" id="compsCardContainer" style="cursor: pointer;">
        <div class="card-icon">
          <img src="../../icons/appFeatures/comps.svg" alt="compsIcon" width="60px" />       
        </div>
        <div class="card-content">
          <h2 class="card-title">Comps</h2>
          <p class="card-description">Browse tier lists and discover the strongest team compositions.</p>
        </div>
      </div>

      <div class="card" id="assistantCardContainer" style="cursor: pointer;">
        <div class="card-icon">
          <img src="../../img/LogoTFT.png" alt="assistantIcon" width="65px" style="filter: brightness(2) saturate(0)" />   
        </div>
        <div class="card-content">
          <h2 class="card-title">Assistant</h2>
          <p class="card-description">Find the best possible moves according to your specific composition.</p>
        </div>
      </div>

      <div class="card" id="builderCardContainer" style="cursor: pointer;">
        <div class="card-icon">
          <img src="../../icons/appFeatures/builder.svg" alt="builderIcon" width="60px" />   
        </div>
        <div class="card-content">
          <h2 class="card-title">Builder</h2>
          <p class="card-description">Plan your strategy with our interactive hex board builder.</p>
        </div>
      </div>
    </div>

    <div class="status-message">
      <span class="loading-dots">Waiting for a TFT match to start</span>
    </div>
  </main>

  <script>
    // Display username immediately from localStorage
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Inline script running');
      const userDataStr = localStorage.getItem('userData');
      console.log('User data from localStorage:', userDataStr);
      
      if (userDataStr) {
        try {
          const userData = JSON.parse(userDataStr);
          console.log('Parsed user data:', userData);
          const welcomeText = document.getElementById('welcomeText');
          if (welcomeText && userData.name) {
            welcomeText.textContent = 'Welcome ' + userData.name + '!';
            console.log('Welcome text updated to:', welcomeText.textContent);
          }
        } catch (e) {
          console.error('Error parsing user data:', e);
        }
      }
      
      // Setup logout handler
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          console.log('Logout clicked');
          
          const sessionToken = localStorage.getItem('sessionToken');
          
          // Call logout endpoint
          if (sessionToken) {
            try {
              await fetch('http://localhost:3000/auth/logout', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: sessionToken })
              });
              console.log('Logout request sent');
            } catch (error) {
              console.error('Logout error:', error);
            }
          }
          
          // Clear localStorage
          localStorage.removeItem('sessionToken');
          localStorage.removeItem('userData');
          console.log('localStorage cleared');
          
          // Redirect to desktop
          window.location.href = 'desktop.html';
        });
      }
      
      // Setup card navigation
      const compsCard = document.getElementById('compsCardContainer');
      if (compsCard) {
        compsCard.addEventListener('click', function() {
          window.location.href = 'comps.html';
        });
      }
      
      const assistantCard = document.getElementById('assistantCardContainer');
      if (assistantCard) {
        assistantCard.addEventListener('click', function() {
          window.location.href = 'assistant.html';
        });
      }
      
      const builderCard = document.getElementById('builderCardContainer');
      if (builderCard) {
        builderCard.addEventListener('click', function() {
          window.location.href = 'builder.html';
        });
      }
    });
  </script>

  <script>
    // Standard Google Universal Analytics code
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      },
        i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      // Note: https protocol here
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-144253676-3', 'auto');

    // Removes failing protocol check. @see: http://stackoverflow.com/a/22152353/1958200
    ga('set', 'checkProtocolTask', function () { });
    ga('require', 'displayfeatures');
    ga('send', 'pageview', '/desktop.html');
  </script>
</body>
</html>